{{ define "content" }}
<div class="panel panel-default">
	<div class="panel-heading">Upload</div>
	<div class="panel-body">
		<select id="typeComboBox" class="input-large form-control">
			<option value="0" selected="selected">Encrypted</option>
			<option value="1">Plain (allows hotlinking)</option>
		</select>
		<span class="btn btn-default btn-file">
		    Choose file <input type="file" onchange="fileChangedCallback(this.files)">
		</span>
		<br/>
		<div style="display: none;" id="progressBarDiv">
			<div class="progress">
				<div class="progress-bar progress-bar-striped active" role="progressbar"
					aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
					style="width: 0%;" id="progressBar">
				</div>
			</div>
			<center>
				<p id="progressBarText">Loading file: 0%</p>
			</center>
		</div>
	</div>
</div>
{{ end }}
{{ define "scripts" }}
<script src="js/sodium.min.js"></script>
<script src="js/base64js.min.js"></script>
<script>
	function fileChangedCallback(files) {
		var file = files[0];
		if (file == null) {
			return;
		}

		if (file.type != "image/jpeg" && file.type != "image/jpg"
			&& file.type != "image/png" && file.type != "image/gif"
			&& file.type != "image/bmp") {
			alert("That doesn't look like an image we support. Only .jpg, .png, .bmp and .gif are supported.");
			return;
		}

		var uploadType = document.getElementById("typeComboBox");
		var shouldEncrypt;

		switch (uploadType.options[uploadType.selectedIndex].value) {
			case "0":
				shouldEncrypt = true;
				break;
			case "1":
				shouldEncrypt = false;
				break;
			default:
				alert("wtf");
				return;
		}

		var bar = document.getElementById("progressBar");
		var barText = document.getElementById("progressBarText");
		document.getElementById("progressBarDiv").style.display = "block";

		var reader = new FileReader();
		reader.onerror = function (e) {
			console.error(e);
		};
		reader.onprogress = function(e) {
			if (!e.lengthComputable) {
				return;
			}

			var percent = Math.round((e.loaded * 100) / e.total);

			bar.style.width = percent + "%";
			bar.aria_valuenow = percent;
			barText.innerHTML = "Loading file: " + percent + "%";
		};
		reader.onload = function (e) {
			bar.style.width = "100%";
			bar.aria_valuenow = 100;

			var reqObj = { data: null,  }
			var key;

			if (shouldEncrypt) {
				barText.innerHTML = "Encrypting file...";

				//using 0 as the nonce
				//this is safe because the generated key will only be used once
				var nonce = new Uint8Array(sodium.crypto_secretbox_NONCEBYTES);

				//and now we pray that the browser uses a csprng
				key = sodium.randombytes_buf(sodium.crypto_secretbox_KEYBYTES);
				var msg = new Uint8Array(e.target.result)
				var encrypted = sodium.crypto_secretbox_easy(msg, nonce, key);

				reqObj.data = base64js.fromByteArray(encrypted);
				reqObj.is_encrypted = true;
				reqObj.extension = "";
			} else {
				reqObj.data = base64js.fromByteArray(new Uint8Array(e.target.result));
				reqObj.is_encrypted = false;
				reqObj.extension = "." + file.name.split('.').pop().toLowerCase()
			}

			var reqString = JSON.stringify(reqObj);
			var req = new XMLHttpRequest();
			req.upload.addEventListener("progress", function(e) {
				if (!e.lengthComputable) {
					return;
				}

				var percent = Math.round((e.loaded * 100) / e.total);

				bar.style.width = percent + "%";
				bar.aria_valuenow = percent;
				barText.innerHTML = "Uploading file: " + percent + "%";
			}, false);
			req.onreadystatechange = function() {
				if (req.readyState != XMLHttpRequest.DONE) {
					return;
				}

				bar.style.width = "100%";
				bar.aria_valuenow = 100;
				barText.innerHTML = "Done!";

				var obj = JSON.parse(req.responseText);
				if (obj.error_code == 0) {
					var loc = obj.location;
					if (shouldEncrypt) {
						loc += "#" + base64js.fromByteArray(key)
					}

					document.location = loc;
				}

				//probably placebo
				if (key != null) {
					sodium.memzero(key);
				}
			};
			req.open("POST", "/ul");
			req.send(reqString);
		};
		reader.readAsArrayBuffer(file);
	}
</script>
{{end}}
